$(function(){const n=(a,c=null)=>{(new URL(window.location.href)).searchParams.has("debug")&&(null==c?console.log(a):console.log("%c"+a,"color: "+c))},h=a=>null==a||""===a?"":a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&#x60/g,"`"),t=(a=null,c=null)=>{a=a??$("#search_bar").val().slice(0,255).trim();if(null==a||""==a)return!0;c=c??$(".type-btn.active").data("type");const e=new URL(window.location.href);e.searchParams.set("search",
a);e.searchParams.set("type",c);e.searchParams.set("page",1);location.href=e.href;return!1},v=()=>{$("#modal").remove();$("#modal_container").removeClass("active");null!==scrollpos?($("body,html").animate({scrollTop:scrollpos},250),setTimeout(function(){$("body").css("overflow","visible")},250)):$("body").css("overflow","visible");l=scrollpos=null},w=(a,c,e=0)=>{console.log(a,c,e);console.log(e);e=["#d1f2a5","#FFFFb0","#FFC0CB"][e];console.log(e);const k=$("<div>",{class:"log"}).css("background-color",
e).append($("<div>",{class:"log-title bold"}).text(a),$("<div>",{class:"log-content"}).text(c),$("<span>",{class:"log-close"}));$("#log_container").append(k);setTimeout(function(){k.fadeOut(1E3,()=>{k.remove()})},2500)};let l=null;const m=new URL(window.location.href),u=m.pathname.split("/").pop().split(".")[0],g={campus:u,search:m.searchParams.get("search"),search_type:m.searchParams.get("type"),page:Number(m.searchParams.get("page"))??1};if(m.searchParams.has("search")){if(1>g.search_type||3<g.search_type)m.searchParams.set("type",
"3"),location.href=m.href;g.search=g.search.slice(0,255);g.search_type=Number(g.search_type)}else"all"!==m.searchParams.get("type")&&(m.searchParams.has("type")||m.searchParams.has("page"))&&(m.searchParams.delete("type"),m.searchParams.delete("page"),location.href=m.href);$("#search_bar").val(g.search);n(g);$.post("./php/search.php",g,function(a){const c=a.status;delete a.status;book_data=a;n(c);var e=20*(c.page-1)+1,k=e>c.count?"XX":e;e=e>c.count?"XX":Math.min(20*c.page,c.count);if(0==c.count)$("<div>",
{id:"search_result"}).text("\u691c\u7d22\u7d50\u679c\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f").append($("<div>",{id:"page_detail"}).text("\u691c\u7d22\u30ef\u30fc\u30c9\u3092\u5909\u66f4\u3057\u3066\u518d\u5ea6\u691c\u7d22\u3057\u3066\u304f\u3060\u3055\u3044")).appendTo("#result_background_img");else if("all"==g.search_type)$("<div>",{id:"search_result"}).text("\u5168\u3066\u306e\u56f3\u66f8("+c.count+"\u4ef6)").append($("<div>",{id:"page_detail"}).text(`\u5168\u4f53\u691c\u7d22 ${k}\u301c${e}\u4ef6\u76ee\u3092\u8868\u793a\u4e2d`)).appendTo("#result_background_img");
else if(1<=g.search_type&&3>=g.search_type){var p=["\u30bf\u30a4\u30c8\u30eb","\u30bf\u30b0","\u30ad\u30fc\u30ef\u30fc\u30c9"][g.search_type-1];$("<div>",{id:"search_result"}).html(`<span id="search_word" class="bold">${g.search}</span>\u3092\u542b\u3080${c.count}\u4ef6\u306e\u691c\u7d22\u7d50\u679c`).append($("<div>",{id:"page_detail"}).text(`${p}\u691c\u7d22 ${k}\u301c${e}\u4ef6\u76ee\u3092\u8868\u793a\u4e2d`)).appendTo("#result_background_img")}else $("<div>",{id:"search_result"}).text("\u30e9\u30f3\u30c0\u30e0\u8868\u793a\uff0820\u4ef6\uff09").appendTo("#result_background_img");
for(let d in a){const b=a[d];n(b);$("<div>",{class:"results-list","data-book_id":d}).append($("<div>",{class:"img-box"}).append($("<img>",{src:"./img/loading.gif",alt:h(b.title)})),$("<div>",{class:"book-info"}).append($("<div>",{class:"title"}).text(h(b.title)),$("<div>",{class:"book-about"}).append($("<span>",{class:"author"}).text(h(b.author)),$("<span>",{class:"publisher"}).text(h(b.publisher))),$("<div>",{class:"description"}).text(h(b.short_introduction)),$("<div>",{class:"detail"}).append($("<div>",
{class:"tag-box"}).append(b.tags.map(f=>$("<span>",{class:"tag"}).text(f))),$("<div>",{class:"modal-view-button","data-id":d})))).appendTo($("#result_container"));if(b.is_image){const f=`./data/book-cover/${b.isbn}.jpg`;$.ajax({url:f,type:"HEAD",success:()=>$(`[data-book_id=${d}] .img-box img`).attr("src",f),error:()=>{$.ajax({url:"./php/get-cover.php?isbn="+b.isbn,type:"GET",success:()=>$(`[data-book_id=${d}] .img-box img`).attr("src",f),error:()=>$(`[data-book_id=${d}] .img-box img`).attr("src",
"./img/error.png")})}})}else $(`[data-book_id=${d}] .img-box img`).attr("src","./img/no-image.png")}if((1<=g.search_type&&3>=g.search_type||"all"===g.search_type)&&0<c.count){k=$("<div>",{class:"pagination"});1==c.page?$("<span>",{id:"prev",class:"btn1 disabled"}).appendTo(k):$("<span>",{id:"prev",class:"btn1","data-page":c.page-1}).appendTo(k);p=Math.max(1,c.page-2);e=Math.min(Math.ceil(c.count/20),p+4);for(p=Math.max(1,e-4);p<=e;p++)p==c.page?$("<span>",{id:"here",class:"btn1 bold"}).text(p).appendTo(k):
$("<span>",{class:"btn2","data-page":p}).text(p).appendTo(k);c.page==Math.ceil(c.count/20)?$("<span>",{id:"next",class:"btn1 disabled"}).appendTo(k):$("<span>",{id:"next",class:"btn1","data-page":c.page+1}).appendTo(k);k.prependTo($("footer"))}$(".modal-view-button").on("click",function(d){n(`Modal Open: ID ${$(d.target).data("id")}`,"green");l=$(d.target).data("id");const b=a[l];null!=b&&(n(`Modal Open: ID ${$(d.target).data("id")}`,"green"),$("#modal").remove(),$("<div>",{id:"modal"}).append($("<h1>",
{class:"modal-title"}).text(h(b.title)),$("<div>",{id:"modal_book_about"}).append($("<span>",{class:"author"}).text(h(b.author)),$("<span>",{class:"publisher"}).text(h(b.publisher)),$("<span>",{class:"isbn"}).text("ISBN: ").append(b.isbn??"\u672a\u5b9a\u7fa9")),$("<div>",{id:"modal_img_box"}).append($("<img>",{src:b.is_image?`./data/book-cover/${b.isbn}.jpg`:"./img/no-image.png",alt:h(b.title)})),$("<div>",{id:"modal_book_info"}).append($("<h3>",{class:"item"}).text("\u6982\u8981"),$("<p>",{class:"description"}).html(b.long_introduction),
$("<h3>",{class:"item"}).text("\u66f8\u7c4d\u60c5\u5831"),$("<table>",{id:"detail_table"}).append($("<tr>",{class:"detail_item"}).append($("<td>").text("ID"),$("<td>").text(l)),$("<tr>",{class:"detail_item"}).append($("<td>").text("\u30bf\u30b0"),$("<td>",{class:"tag-box"}).append($("<label>",{id:"edit_button"}).append($("<input>",{type:"checkbox",id:"edit_mode"}),$("<input>",{type:"text",id:"tag_input",placeholder:"\u30bf\u30b0\u3092\u8ffd\u52a0",inputmode:"search"}),$("<span>",{id:"edit_text"}).text("\u7de8\u96c6")),
b.tags.map(f=>$("<span>",{class:"tag"}).text(f)))),$("<tr>",{class:"detail_item"}).append($("<td>").text("\u51fa\u7248\u65e5"),$("<td>").text(h(b.pubdate)))),$("<h3>",{class:"item"}).text("\u8457\u8005\u60c5\u5831"),Object.keys(b.authors||{}).map(f=>$("<div>",{class:"author-list"}).append($("<span>",{class:"author-name bold"}).text(f),$("<span>",{class:"author-kana"}).text(b.authors[f].author_kana),$("<p>",{class:"author-description"}).html(b.authors[f].author_description))))).appendTo($("#modal_container")),
scrollpos=$(window).scrollTop(),$("body").css("overflow","hidden"),$("#modal_container").addClass("active"))});$(".btn1,.btn2").on("click",function(d){d=$(d.target).data("page");if(null!=d){var b=new URL(location.href);b.searchParams.set("page",d);location.href=b}});console.log("\u8aad\u307f\u8fbc\u307f\u5b8c\u4e86");$(document).on("keydown","#tag_input",function(d){console.log(d.keyCode+"\u304c\u62bc\u3055\u308c\u307e\u3057\u305f"+l);if(13==d.keyCode&&null!=l){console.log("\u30bf\u30b0\u8ffd\u52a0\u51e6\u7406");
const b=$(this).val();""!=b&&$.post("./php/tag-edit.php",{id:l,tag:b,type:"add",campus:u},function(f){n(f);$("#tag_input").val("");var q="\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f",r=2;if(201==f.status.code){q=$(`.results-list[data-book_id=${l}] .tag-box`);r=$("#modal .tag-box");let x=$("<span>",{class:"tag"}).text(b);q.append(x.clone());r.append(x.append($("<span>",{class:"delete"})));a[l].tags.push(b);q=`\u30bf\u30b0\u300c${b}\u300d\u3092\u8ffd\u52a0\u3057\u307e\u3057\u305f`;
r=0}else 204==f.status.code&&(q="\u52d5\u4f5c\u3092\u5b8c\u4e86\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f",r=1);w(q,`${f.status.code} ${f.status.message}`,r);$(window).trigger("resize")},"json")}});$(document).on("click",".delete",function(){const d=$(this).parent().text();$.post("./php/tag-edit.php",{id:l,tag:d,type:"remove",campus:u},function(b){n(b);let f="\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f",q=2;201==b.status.code?($(`.results-list[data-book_id=${l}] .tag-box,#modal .tag-box`).find(".tag").filter(function(){return $(this).text()===
d}).remove(),a[l].tags=a[l].tags.filter(function(r){return r!=d}),f=`\u30bf\u30b0\u300c${d}\u300d\u3092\u524a\u9664\u3057\u307e\u3057\u305f`,q=0):204==b.status.code&&(f="\u52d5\u4f5c\u3092\u5b8c\u4e86\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f",q=1);w(f,`${b.status.code} ${b.status.message}`,q);$(window).trigger("resize")},"json")})});$.getJSON("./data/tags.json",function(a){const c=$("<datalist>").attr("id","tagsList");a.forEach(e=>{c.append($("<option>").attr("value",e))});$("#search_bar").after(c)});
$("html").keydown(function(a){27==a.keyCode&&v()});$("#modal_container").click(function(a){$(a.target).closest("#modal").length||v()});$("#search_bar").on("keydown",function(a){"Enter"==a.key&&t($("#search_bar").val().slice(0,255).trim())&&(a=new URL(location.href),a.searchParams.delete("search"),a.searchParams.delete("page"),a.searchParams.set("type","all"),location.href=a)});$("#search_bar").on("click",function(){this.setSelectionRange(0,this.value.length)});$("#search_btn").on("click",function(){t($("#search_bar").val().slice(0,
255).trim())});$(".type-btn").click(function(){$(".type-btn.active").removeClass("active");$(this).addClass("active");2==$(this).data("type")?$("#search_bar").attr("list","tagsList"):$("#search_bar").removeAttr("list")});$("#to_top").on("click",function(){$("html,body").animate({scrollTop:0},300,"swing")});$(document).on("change","#edit_mode",function(){const a=$(this),c=a.closest("td");a.prop("checked")?($("#tag_input").attr("list","tagsList"),$("#edit_text").text(""),c.addClass("checked"),c.find(".tag").each(function(){$(this).append($("<span>",
{class:"delete"}))})):(c.removeClass("checked"),c.find(".delete").remove(),setTimeout(function(){$("#tag_input").replaceWith($("<input>",{type:"text",id:"tag_input",placeholder:"\u30bf\u30b0\u3092\u8ffd\u52a0",inputmode:"search"}));$("#edit_text").text("\u7de8\u96c6")},300))});$(document).on("click",".tag",function(){$("#modal .tag-box.checked").length||t($(this).text(),2)});$(document).on("click",".log-close",function(){$(this).closest(".log").remove()})});
$(window).on("resize",function(){$(".ellipsis").remove();$(".results-list .tag-box").each(function(){const n=$(this).position().left+$(this).outerWidth()-20;$(this).find(".tag").each(function(){const h=$(this);if(h.position().left+h.outerWidth()>n)return h.before($("<span>",{class:"ellipsis",style:"padding-right:100%;"}).text("\u2026")),!1})});$("main").css("min-height",`calc(100vh - ${$("header").outerHeight()+$("footer").outerHeight()}px)`)});
$(window).on("scroll resize",function(){const n=$("footer").offset().top,h=$("footer").outerHeight();$(window).scrollTop()+$(window).height()>n&&n+h>$(window).scrollTop()?$("#to_top").css("position","absolute"):$("#to_top").css("position","fixed")});
